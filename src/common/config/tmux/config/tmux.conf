##### Prefix 使用默认 C-b #####
set-option -g prefix C-b
unbind-key C-a
bind-key C-b send-prefix

##### 行为与通用设置 #####
set-option -g repeat-time 0
set-option -g base-index 1
set-window-option -g pane-base-index 1
set-option -g renumber-windows on
set-option -g automatic-rename on
set-window-option -g monitor-activity on
set-option -g visual-activity off
set-option -g history-limit 50000
set-option -g mouse on
set-option -sg escape-time 0
set-option -g focus-events on
set-option -g default-terminal "tmux-256color"
set-option -ga terminal-overrides ",*256col*:Tc"
set-option -ga terminal-overrides ",ghostty:Tc"
set-option -g set-clipboard on
set-option -g allow-passthrough on

##### 标题 #####
set-option -g set-titles on

##### 复制模式 #####
set-window-option -g mode-keys vi
bind-key [ copy-mode
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'y' send -X copy-selection-and-cancel

# 优化鼠标体验：拖拽结束自动复制到系统剪贴板 (OSC 52)
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-selection-and-cancel


##### Pane 导航（Vim hjkl）#####
bind-key -r h select-pane -L
bind-key -r j select-pane -D
bind-key -r k select-pane -U
bind-key -r l select-pane -R

# 快速切换到最后一个面板
bind-key Tab last-pane

##### Pane 调整大小 #####
bind-key -r H resize-pane -L 5
bind-key -r J resize-pane -D 5
bind-key -r K resize-pane -U 5
bind-key -r L resize-pane -R 5

# 快速交换面板位置
bind-key -r "}" swap-pane -D
bind-key -r "{" swap-pane -U

##### 关闭确认去除 #####
bind-key x kill-pane
bind-key & kill-window

##### 窗口导航 #####
# 回到上一个窗口
bind-key ^ last-window

# 上一个/下一个窗口（对应 Ghostty ⌘[/⌘]）
bind-key p previous-window
bind-key n next-window

# 窗口重新排序
bind-key -r < swap-window -t -1 -d
bind-key -r > swap-window -t +1 -d

##### 新窗口/分割（保持当前路径）#####
bind-key c new-window -c "#{pane_current_path}"
bind-key % split-window -h -c "#{pane_current_path}"
bind-key '"' split-window -v -c "#{pane_current_path}"

##### Pane 移动到指定窗口 #####
bind-key M-1 join-pane -t :1
bind-key M-2 join-pane -t :2
bind-key M-3 join-pane -t :3
bind-key M-4 join-pane -t :4
bind-key M-5 join-pane -t :5
bind-key M-6 join-pane -t :6
bind-key M-7 join-pane -t :7
bind-key M-8 join-pane -t :8
bind-key M-9 join-pane -t :9

##### 快捷弹窗 #####
# 命令选择器（添加窗口大小确保 fzf 显示完整）
bind-key R display-popup -E -w 90% -h 80% "~/.config/tmux/bin/tmux-commands | xargs -I{} tmux send-keys '{}' enter"
bind-key C display-popup -E -w 90% -h 80% "~/.config/tmux/bin/tmux-commands | xargs tmux new-window -c '#{pane_current_path}'"
bind-key | display-popup -E -w 90% -h 80% "~/.config/tmux/bin/tmux-commands | xargs tmux split-window -v -c '#{pane_current_path}'"
bind-key - display-popup -E -w 90% -h 80% "~/.config/tmux/bin/tmux-commands | xargs tmux split-window -h -c '#{pane_current_path}'"

# 快速临时终端（scratch pad）
bind-key g display-popup -E -w 90% -h 90% -d "#{pane_current_path}"

# 快速 man 手册
bind-key M command-prompt -p "man:" "display-popup -E -w 80% -h 90% 'man %%'"

# 快速 git 状态
bind-key G display-popup -E -w 90% -h 90% -d "#{pane_current_path}" "git status && echo && echo 'Press ENTER to close' && read"

##### 会话管理 #####
bind-key N new-session -A -c "#{pane_current_path}" -s "#(basename #{pane_current_path})"
bind-key X kill-session
bind-key S display-popup -E -w 80% -h 60% "~/.config/tmux/bin/tmux-sessions | xargs tmux switch-client -t"

bind-key P if-shell -F '#{==:#{session_name},popup}' {
  detach-client
} {
  if-shell -F '#{e|==:#{N/s:popup},0}' {
    new-session -d -s 'popup' 'tmux source-file ~/.config/tmux/sessions/popup.tmux.conf'
  }
  display-popup -w 80% -h 80% -E "tmux attach-session -t popup"
}

bind-key I set-window-option synchronize-panes

##### 默认 shell（按常见安装路径探测）#####
if-shell 'test -e /home/linuxbrew/.linuxbrew/bin/zsh' {
  set-option -g default-shell /home/linuxbrew/.linuxbrew/bin/zsh
}
if-shell 'test -e /opt/homebrew/bin/zsh' {
  set-option -g default-shell /opt/homebrew/bin/zsh
}
if-shell 'test -e /usr/local/bin/zsh' {
  set-option -g default-shell /usr/local/bin/zsh
}
if-shell 'test -e /usr/bin/zsh' {
  set-option -g default-shell /usr/bin/zsh
}
if-shell 'test -e /opt/local/bin/zsh' {
  set-option -g default-shell /opt/local/bin/zsh
}
if-shell 'test -e /bin/zsh' {
  set-option -g default-shell /bin/zsh
}

##### 状态栏（冷青极客风）#####
# 背景/前景
set-option -g status on
set-option -g status-interval 15
set-option -g status-position top
set-option -g status-justify left
set-option -g status-style none,fg=#f5f5f7,bg=#1d1d1f

###### 左侧：会话名 | 窗口数 | (前缀指示) ######
set -g status-left-length 80
set -g status-left-style none
# 主强调色改为冷青 #32ade6；分隔符 #3a3a3c；次字 #8e8e93
set -g status-left '#[fg=#ffffff,bg=#32ade6,bold] #S #[fg=#3a3a3c,bg=#1d1d1f]| #[fg=#8e8e93]#{session_windows}w#{?client_prefix, #[fg=#3a3a3c]| #[fg=#ffd60a]PFX,} '

###### 右侧：极简（时间 | 项目 | 分支 | CPU/电池 | 主机名）######
set -g status-right-length 120
set -g status-right-style none
set -g status-right '#[fg=#8e8e93,bg=#1d1d1f] %H:%M #[fg=#3a3a3c]| #[fg=#f5f5f7]#(basename "#{pane_current_path}")#[fg=#3a3a3c]| #{?#{==:#{pane_current_path},},,#[fg=#32ade6]#(~/.config/tmux/bin/git-branch "#{pane_current_path}")}#[fg=#3a3a3c]| #[fg=#f5f5f7]#(~/.config/tmux/bin/sysinfo) #[fg=#3a3a3c]| #[fg=#8e8e93]@#h'

###### 窗口标签（极简清晰）######
# 未激活窗口：二级灰底、次文字色
set -g window-status-separator ' '
set -g window-status-style "fg=#8e8e93,bg=#2c2c2e"
set -g window-status-format '#[fg=#8e8e93,bg=#2c2c2e] #I:#W#{?window_zoomed_flag, Z,}#{?window_activity_flag, •,} '

# 当前窗口：冷青底白字
set -g window-status-current-style "fg=#ffffff,bg=#32ade6"
set -g window-status-current-format '#[fg=#ffffff,bg=#32ade6] #I:#W#{?window_zoomed_flag, Z,} '

# 活动高亮/消息（系统黄）
set -g window-status-activity-style "fg=#ffd60a,bg=#3a3a3c"

###### Pane 边框与消息框 ######
# 活动边框用亮青，普通边框中性灰
set-option -g pane-active-border-style fg='#5ac8fa'
set-option -g pane-border-style fg='#5a5a5e'

# 消息框：三级灰底，白字
set-option -g message-style none,fg='#ffffff',bg='#3a3a3c'
set-option -g message-command-style none,fg='#ffffff',bg='#3a3a3c'
