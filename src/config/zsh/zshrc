#!/usr/bin/env zsh
# ============================================
# Oh My Zsh åŠ è½½
# ============================================
# æ€§èƒ½ä¼˜åŒ–ï¼šè·³è¿‡ä¸€äº›æ£€æŸ¥ä»¥åŠ å¿«å¯åŠ¨é€Ÿåº¦
DISABLE_UPDATE_PROMPT=true
DISABLE_AUTO_UPDATE=false

[[ -f ~/.oh-my-zsh.sh ]] && source ~/.oh-my-zsh.sh

# ============================================
# åŠ è½½è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
# ============================================
# exports - åº”ç”¨ç‰¹å®šçŽ¯å¢ƒå˜é‡
[[ -f ~/.exports ]] && source ~/.exports

# aliases - å‘½ä»¤åˆ«å
[[ -f ~/.aliases ]] && source ~/.aliases

# functions - è‡ªå®šä¹‰å‡½æ•°
[[ -f ~/.funcs ]] && source ~/.funcs

# envconfig - çŽ¯å¢ƒé…ç½®
[[ -f ~/.envconfig ]] && source ~/.envconfig

# Local config - æœ¬åœ°ç‰¹å®šé…ç½®
[[ -f ~/.zshrc.local ]] && source ~/.zshrc.local

# ============================================
# å·¥å…·åˆå§‹åŒ–ï¼ˆåªåœ¨äº¤äº’å¼ shell ä¸­ï¼‰
# ============================================
if [[ -o interactive ]]; then
  # ç¦ç”¨ Ctrl+S / Ctrl+Q æµé‡æŽ§åˆ¶ (é˜²æ­¢è¯¯æŒ‰å¯¼è‡´ç»ˆç«¯å†»ç»“)
  stty -ixon

  # zoxide - æ™ºèƒ½ç›®å½•è·³è½¬
  if command -v zoxide &>/dev/null; then
    eval "$(zoxide init zsh)"
  fi

  # mise - ç‰ˆæœ¬ç®¡ç†å™¨
  if command -v mise &>/dev/null; then
    eval "$(mise activate zsh)"
  fi

  # # CCE Shell Integration
  # if [[ -f ~/.cce/config.toml ]]; then
  #   current_provider=$(awk -F\" '/^current_provider/ {print $2}' ~/.cce/config.toml)
  #   if [[ -n "$current_provider" ]]; then
  #     eval "$(CCE_SHELL_INTEGRATION=1 cce use "$current_provider")"
  #   fi
  # fi

  # fzf - æ¨¡ç³ŠæŸ¥æ‰¾å™¨ï¼ˆå¦‚æžœé€šè¿‡ Homebrew å®‰è£…ï¼‰
  if [[ -f "$HOMEBREW_PREFIX/opt/fzf/shell/completion.zsh" ]]; then
    source "$HOMEBREW_PREFIX/opt/fzf/shell/completion.zsh"
  fi
  if [[ -f "$HOMEBREW_PREFIX/opt/fzf/shell/key-bindings.zsh" ]]; then
    source "$HOMEBREW_PREFIX/opt/fzf/shell/key-bindings.zsh"
  fi
fi

# ============================================
# Zsh æ’ä»¶åŠ è½½ï¼ˆé€šè¿‡ Homebrew å®‰è£…ï¼‰
# ============================================
# æ³¨æ„ï¼šzsh-autocomplete å’Œ zsh-autosuggestions åŠŸèƒ½é‡å 
# æŽ¨èåªå¯ç”¨å…¶ä¸­ä¸€ä¸ªä»¥é¿å…å†²çª
#
# é€‰é¡¹ 1ï¼šä½¿ç”¨ zsh-autocompleteï¼ˆå®žæ—¶è‡ªåŠ¨è¡¥å…¨ï¼Œæ›´æ™ºèƒ½ä½†å¯èƒ½è¾ƒæ…¢ï¼‰
# é€‰é¡¹ 2ï¼šä½¿ç”¨ zsh-autosuggestionsï¼ˆåŸºäºŽåŽ†å²å»ºè®®ï¼Œæ›´å¿«ä½†åŠŸèƒ½ç®€å•ï¼‰
#
# å½“å‰å¯ç”¨ï¼šzsh-autosuggestionsï¼ˆæŽ¨èï¼Œæ€§èƒ½æ›´å¥½ï¼‰

# zsh-autocompleteï¼ˆå¦‚æžœéœ€è¦æ›´å¼ºå¤§çš„è¡¥å…¨ï¼Œå–æ¶ˆæ³¨é‡Šå¹¶æ³¨é‡ŠæŽ‰ zsh-autosuggestionsï¼‰
# æ³¨æ„ï¼šzsh-autocomplete å¿…é¡»åœ¨å…¶ä»–è¡¥å…¨æ’ä»¶ä¹‹å‰åŠ è½½
# if [[ -f "$HOMEBREW_PREFIX/share/zsh-autocomplete/zsh-autocomplete.plugin.zsh" ]]; then
#   source "$HOMEBREW_PREFIX/share/zsh-autocomplete/zsh-autocomplete.plugin.zsh"
# fi

# zsh-autosuggestionsï¼ˆæŽ¨èï¼ŒåŸºäºŽåŽ†å²çš„å¿«é€Ÿå»ºè®®ï¼‰
if [[ -f "$HOMEBREW_PREFIX/share/zsh-autosuggestions/zsh-autosuggestions.zsh" ]]; then
  source "$HOMEBREW_PREFIX/share/zsh-autosuggestions/zsh-autosuggestions.zsh"
  # é…ç½®å»ºè®®é¢œè‰²ï¼ˆå¯é€‰ï¼‰
  ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE='fg=8'
fi

# zsh-history-substring-searchï¼ˆåŽ†å²æœç´¢å¢žå¼ºï¼‰
if [[ -f "$HOMEBREW_PREFIX/share/zsh-history-substring-search/zsh-history-substring-search.zsh" ]]; then
  source "$HOMEBREW_PREFIX/share/zsh-history-substring-search/zsh-history-substring-search.zsh"
  # ç»‘å®šä¸Šä¸‹ç®­å¤´é”®
  bindkey '^[[A' history-substring-search-up
  bindkey '^[[B' history-substring-search-down
fi

# zsh-syntax-highlightingï¼ˆè¯­æ³•é«˜äº®ï¼Œå¿…é¡»æœ€åŽåŠ è½½ï¼‰
if [[ -f "$HOMEBREW_PREFIX/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" ]]; then
  source "$HOMEBREW_PREFIX/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
fi

# ============================================
# SSH helper
# ============================================
if [[ -f "$HOME/.zsh/zsh-ssh/zsh-ssh.zsh" ]]; then
  source "$HOME/.zsh/zsh-ssh/zsh-ssh.zsh"
fi

# ============================================
# Bun è¡¥å…¨
# ============================================
if [[ -s "$HOME/.bun/_bun" ]]; then
  source "$HOME/.bun/_bun"
fi

# ============================================
# åŽ†å²è®°å½•é…ç½®
# ============================================
HISTFILE=~/.zsh_history
HISTSIZE=50000
SAVEHIST=50000
setopt EXTENDED_HISTORY          # è®°å½•æ—¶é—´æˆ³
setopt HIST_EXPIRE_DUPS_FIRST    # ä¼˜å…ˆåˆ é™¤é‡å¤çš„åŽ†å²è®°å½•
setopt HIST_IGNORE_DUPS          # ä¸è®°å½•è¿žç»­é‡å¤çš„å‘½ä»¤
setopt HIST_IGNORE_SPACE         # å¿½ç•¥ä»¥ç©ºæ ¼å¼€å¤´çš„å‘½ä»¤
setopt HIST_VERIFY               # åŽ†å²æ‰©å±•æ—¶å…ˆæ˜¾ç¤ºï¼Œä¸ç«‹å³æ‰§è¡Œ
setopt SHARE_HISTORY             # åœ¨å¤šä¸ª shell ä¹‹é—´å…±äº«åŽ†å²è®°å½•
setopt HIST_REDUCE_BLANKS        # åˆ é™¤å¤šä½™çš„ç©ºæ ¼
setopt HIST_FIND_NO_DUPS         # åŽ†å²æœç´¢æ—¶ä¸æ˜¾ç¤ºé‡å¤é¡¹

# ============================================
# Zsh é€‰é¡¹
# ============================================
setopt AUTO_CD                   # è¾“å…¥ç›®å½•åè‡ªåŠ¨ cd
setopt AUTO_PUSHD                # cd æ—¶è‡ªåŠ¨ pushd
setopt PUSHD_IGNORE_DUPS         # pushd æ—¶å¿½ç•¥é‡å¤ç›®å½•
setopt CORRECT                   # å‘½ä»¤æ‹¼å†™çº æ­£
setopt INTERACTIVE_COMMENTS      # å…è®¸åœ¨äº¤äº’å¼ shell ä¸­ä½¿ç”¨æ³¨é‡Š
setopt NO_BEEP                   # ç¦ç”¨èœ‚é¸£å£°
setopt MULTIOS                   # å…è®¸å¤šé‡é‡å®šå‘

# ============================================
# é”®ç»‘å®š
# ============================================
# ä½¿ç”¨ Emacs é£Žæ ¼çš„é”®ç»‘å®šï¼ˆæˆ–è€…ä½¿ç”¨ bindkey -v æ¥ä½¿ç”¨ Vi é£Žæ ¼ï¼‰
bindkey -e

# é¢å¤–çš„æœ‰ç”¨é”®ç»‘å®š
bindkey '^[[H' beginning-of-line      # Home é”®
bindkey '^[[F' end-of-line            # End é”®
bindkey '^[[3~' delete-char           # Delete é”®
bindkey '^[[1;5C' forward-word        # Ctrl+Right å‰è¿›ä¸€ä¸ªè¯
bindkey '^[[1;5D' backward-word       # Ctrl+Left åŽé€€ä¸€ä¸ªè¯

# ============================================
# tmux çŽ¯å¢ƒæç¤ºï¼ˆå¯é€‰ï¼‰
# ============================================
# åœ¨ tmux ä¸­æ˜¾ç¤ºä¸€ä¸ªå°æç¤º
if [[ -n "$TMUX" ]]; then
  # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ  tmux ç‰¹å®šçš„é…ç½®
  # ä¾‹å¦‚ï¼šæ˜¾ç¤ºå½“å‰ tmux ä¼šè¯å
  # echo "ðŸ“º tmux session: $(tmux display-message -p '#S')"
  :
fi

# ============================================
# æ€§èƒ½ä¼˜åŒ–
# ============================================
# å»¶è¿ŸåŠ è½½é‡é‡çº§å‘½ä»¤ï¼ˆå¦‚æžœéœ€è¦ï¼‰
# å–æ¶ˆæ³¨é‡Šä»¥å¯ç”¨å»¶è¿ŸåŠ è½½
# autoload -Uz compinit
# if [[ -n ${ZDOTDIR}/.zcompdump(#qN.mh+24) ]]; then
#   compinit
# else
#   compinit -C
# fi

# ============================================
# å¯åŠ¨æ—¶é—´æµ‹è¯•ï¼ˆè°ƒè¯•ç”¨ï¼‰
# ============================================
# æµ‹é‡ shell å¯åŠ¨æ—¶é—´
# ä½¿ç”¨æ–¹æ³•ï¼š
#   1. åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ ï¼šzmodload zsh/zprof
#   2. åœ¨æ–‡ä»¶åº•éƒ¨å–æ¶ˆä¸‹é¢çš„æ³¨é‡Š
#   3. é‡å¯ shell æŸ¥çœ‹æ€§èƒ½åˆ†æž
# zprof

# Added by LM Studio CLI (lms)
# NOTE: avoid hardcoding the username; use $HOME for portability.
export PATH="$PATH:$HOME/.cache/lm-studio/bin"
# End of LM Studio CLI section
# # >>> CCE Shell Integration >>>
# if command -v cce >/dev/null 2>&1; then
#   _cce_binary="$(command -v cce)"

#   cce() {
#     if [[ "$1" == "use" && -n "$2" ]]; then
#       local _output
#       _output=$(CCE_SHELL_INTEGRATION=1 "$_cce_binary" use "$2" 2>/dev/null)
#       if [[ $? -eq 0 && -n "$_output" ]]; then
#         eval "$_output"
#         echo "âš¡ Switched to service provider '$2'"
#         echo "âœ… Environment variables are now active in current terminal"
#         return 0
#       fi
#     elif [[ "$1" == "clear" ]]; then
#       local _output
#       _output=$(CCE_SHELL_INTEGRATION=1 "$_cce_binary" clear 2>/dev/null)
#       if [[ $? -eq 0 && -n "$_output" ]]; then
#         eval "$_output"
#         echo "ðŸ§¹ Cleared service provider configuration"
#         echo "âœ… Environment variables are now unset in current terminal"
#         return 0
#       fi
#     fi

#     "$_cce_binary" "$@"
#   }

#   __cce_apply_current_provider() {
#     local _cfg="$HOME/.cce/config.toml"
#     if [[ -f "$_cfg" ]]; then
#       local _provider
#       _provider=$(awk -F'"' '/^current_provider/ {print $2; exit}' "$_cfg")
#       if [[ -n "$_provider" ]]; then
#         local _boot_output
#         _boot_output=$(CCE_SHELL_INTEGRATION=1 "$_cce_binary" use "$_provider" 2>/dev/null)
#         if [[ $? -eq 0 && -n "$_boot_output" ]]; then
#           eval "$_boot_output"
#         fi
#       fi
#     fi
#   }

#   __cce_apply_current_provider
#   unset -f __cce_apply_current_provider
# fi
# # <<< CCE Shell Integration <<<
export PATH="$HOME/.npm-global/bin:$PATH"

# Added by Antigravity
# NOTE: avoid hardcoding the username; use $HOME for portability.
export PATH="$HOME/.antigravity/antigravity/bin:$PATH"

# Added by LM Studio CLI (lms)
# NOTE: avoid hardcoding the username; use $HOME for portability.
export PATH="$PATH:$HOME/.lmstudio/bin"
# End of LM Studio CLI section
